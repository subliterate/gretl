topsrc = @top_srcdir@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
includedir = @includedir@
datarootdir = @datarootdir@
datadir = @datadir@
mandir = @mandir@
localedir = @localedir@
CC = @CC@
CXX = @CXX@
CFLAGS = @CFLAGS@
INSTALL = @INSTALL@
LN = @LN_S@
HOSTCC = @HOSTCC@
build_gui = @build_gui@
gtk_version = @gtk_version@
build_po = @build_po@
build_doc = @build_docs@
build_addons = @build_addons@
build_editor = @build_editor@
use_xdg = @use_xdg@
use_xdg_utils = @use_xdg_utils@
FETCH_PROG = @FETCH_PROG@
TAR_PROG = @TAR_PROG@
X13AS_URL = @X13AS_URL@
TRAMO_SEATS_URL = @TRAMO_SEATS_URL@
download_x13as = @download_x13as@
download_tramo_seats = @download_tramo_seats@

ifeq ($(CC),)
  CC = gcc
endif

ifeq ($(CXX),)
  CXX = g++
endif

ifeq ($(HOSTCC),)
  HOSTCC = $(CC)
endif

ifeq ($(build_gui),yes)
  GUIDIR = gui
endif

ifeq ($(build_po),yes)
  PODIR = po
endif

ifeq ($(build_doc),yes)
  DOCDIR = doc
endif

ifeq ($(build_addons),yes)
  ADDONSDIR = addons
endif

ifeq ($(build_editor),yes)
  EDDIR = editor
endif

ifeq ($(use_xdg),yes)
  XDGDIR = xdg
endif

INSTALL_PROGRAM = ${INSTALL} -m 755
INSTALL_DATA = ${INSTALL} -m 644

export

tooldir = $(topsrc)/tools

SUBDIRS = lib cli $(GUIDIR) $(EDDIR) plugin $(PODIR) share $(XDGDIR) $(ADDONSDIR)
ALLSUBDIRS = lib cli gui editor plugin po share tests doc xdg addons

.PHONY : subdirs $(SUBDIRS) clean installdirs install install-strip \
install-man uninstall uninstall-main uninstall-xdg extras-fetch extras-install tags dist distclean check buildstamp

subdirs: $(SUBDIRS) extras-fetch

$(SUBDIRS):
	$(MAKE) -C $@

pdfdocs:
	if [ "x$(DOCDIR)" = "x" ] ; then \
	echo "pdfdocs: this target is not enabled" ; else \
	$(MAKE) -C $(DOCDIR) ; fi

clean:
	for d in $(SUBDIRS) ; do $(MAKE) -C $$d clean; done
	$(MAKE) -C utils/emacs clean
	rm -f build.h builddate

installdirs:
	$(tooldir)/mkinstalldirs $(libdir) $(includedir) $(bindir)

install: $(SUBDIRS) installdirs install-man
	for d in $(SUBDIRS) ; do $(MAKE) -C $$d install || exit 1; done
	$(MAKE) extras-install

install-strip: $(SUBDIRS) installdirs install-man	
	for d in $(SUBDIRS) ; do $(MAKE) -C $$d install-strip || exit 1; done
	$(MAKE) extras-install

install-doc: pdfdocs
	$(MAKE) -C $(DOCDIR) install

install-man:
	$(tooldir)/install_man $(tooldir) $(DESTDIR)$(prefix) $(topsrc)/gretl.1

EXTRAS_DIR ?= $(CURDIR)/.gretl-extras
EXTRAS_DISTDIR = $(EXTRAS_DIR)/distfiles
EXTRAS_UNPACKDIR = $(EXTRAS_DIR)/unpack

X13AS_TARBALL = $(EXTRAS_DISTDIR)/x13as-linux-64.tar.gz
TRAMO_SEATS_TARBALL = $(EXTRAS_DISTDIR)/tramo-seats-linux-64.tar.gz

X13AS_UNPACK_STAMP = $(EXTRAS_UNPACKDIR)/.x13as-unpacked
TRAMO_SEATS_UNPACK_STAMP = $(EXTRAS_UNPACKDIR)/.tramo-seats-unpacked

$(X13AS_TARBALL):
	$(tooldir)/mkinstalldirs $(EXTRAS_DISTDIR)
	@if [ "x$(download_x13as)" != "xyes" ] ; then exit 0 ; fi ; \
	echo "Downloading x13as package..." ; \
	if [ "x$(FETCH_PROG)" = "xcurl" ] ; then \
	  curl -L --fail -o "$@" "$(X13AS_URL)" ; \
	elif [ "x$(FETCH_PROG)" = "xwget" ] ; then \
	  wget -O "$@" "$(X13AS_URL)" ; \
	else \
	  echo "No supported download program (need curl or wget)" ; exit 1 ; \
	fi

$(TRAMO_SEATS_TARBALL):
	$(tooldir)/mkinstalldirs $(EXTRAS_DISTDIR)
	@if [ "x$(download_tramo_seats)" != "xyes" ] ; then exit 0 ; fi ; \
	echo "Downloading tramo-seats package..." ; \
	if [ "x$(FETCH_PROG)" = "xcurl" ] ; then \
	  curl -L --fail -o "$@" "$(TRAMO_SEATS_URL)" ; \
	elif [ "x$(FETCH_PROG)" = "xwget" ] ; then \
	  wget -O "$@" "$(TRAMO_SEATS_URL)" ; \
	else \
	  echo "No supported download program (need curl or wget)" ; exit 1 ; \
	fi

$(X13AS_UNPACK_STAMP): $(X13AS_TARBALL)
	$(tooldir)/mkinstalldirs $(EXTRAS_UNPACKDIR)
	@if [ "x$(download_x13as)" != "xyes" ] ; then exit 0 ; fi ; \
	"$(TAR_PROG)" -xzf "$(X13AS_TARBALL)" -C "$(EXTRAS_UNPACKDIR)" ; \
	touch "$@"

$(TRAMO_SEATS_UNPACK_STAMP): $(TRAMO_SEATS_TARBALL)
	$(tooldir)/mkinstalldirs $(EXTRAS_UNPACKDIR)
	@if [ "x$(download_tramo_seats)" != "xyes" ] ; then exit 0 ; fi ; \
	"$(TAR_PROG)" -xzf "$(TRAMO_SEATS_TARBALL)" -C "$(EXTRAS_UNPACKDIR)" ; \
	touch "$@"

extras-fetch:
	@if [ "x$(download_x13as)" = "xyes" ] ; then \
	  $(MAKE) "$(X13AS_UNPACK_STAMP)" ; \
	fi
	@if [ "x$(download_tramo_seats)" = "xyes" ] ; then \
	  $(MAKE) "$(TRAMO_SEATS_UNPACK_STAMP)" ; \
	fi

extras-install: extras-fetch
	@if [ "x$(download_x13as)" = "xyes" ] ; then \
	  $(tooldir)/mkinstalldirs \
	    $(DESTDIR)$(datarootdir)/gretl/x13as/bin \
	    $(DESTDIR)$(datarootdir)/gretl/x13as/docs \
	    $(DESTDIR)$(datarootdir)/gretl/doc ; \
	  $(INSTALL_PROGRAM) $(EXTRAS_UNPACKDIR)/opt/x13as/bin/x13as \
	    $(DESTDIR)$(datarootdir)/gretl/x13as/bin/x13as ; \
	  $(INSTALL_DATA) $(EXTRAS_UNPACKDIR)/opt/x13as/docs/docx13as.pdf \
	    $(DESTDIR)$(datarootdir)/gretl/x13as/docs/docx13as.pdf ; \
	  $(INSTALL_DATA) $(EXTRAS_UNPACKDIR)/opt/x13as/docs/docx13as.pdf \
	    $(DESTDIR)$(datarootdir)/gretl/doc/docX13AS.pdf ; \
	  $(INSTALL_DATA) $(EXTRAS_UNPACKDIR)/opt/x13as/docs/qrefx13asunix.pdf \
	    $(DESTDIR)$(datarootdir)/gretl/doc/qrefx13asunix.pdf ; \
	fi
	@if [ "x$(download_tramo_seats)" = "xyes" ] ; then \
	  $(tooldir)/mkinstalldirs \
	    $(DESTDIR)$(datarootdir)/gretl/tramo/bin ; \
	  $(INSTALL_PROGRAM) $(EXTRAS_UNPACKDIR)/opt/tramo/bin/tramo \
	    $(DESTDIR)$(datarootdir)/gretl/tramo/bin/tramo ; \
	  $(INSTALL_PROGRAM) $(EXTRAS_UNPACKDIR)/opt/tramo/bin/seats \
	    $(DESTDIR)$(datarootdir)/gretl/tramo/bin/seats ; \
	fi

uninstall: uninstall-main uninstall-xdg
	@:

uninstall-main:
	rm -f \
	  $(DESTDIR)$(bindir)/gretl \
	  $(DESTDIR)$(bindir)/gretlcli \
	  $(DESTDIR)$(bindir)/gretl_x11 \
	  $(DESTDIR)$(bindir)/gretlmpi
	rm -rf \
	  $(DESTDIR)$(includedir)/gretl \
	  $(DESTDIR)$(prefix)/include/gretl \
	  $(DESTDIR)$(libdir)/gretl-gtk3 \
	  $(DESTDIR)$(datarootdir)/gretl
	rm -f \
	  $(DESTDIR)$(libdir)/libgretl-1.0.la \
	  $(DESTDIR)$(libdir)/libgretl-1.0.so \
	  $(DESTDIR)$(libdir)/libgretl-1.0.so.* \
	  $(DESTDIR)$(libdir)/pkgconfig/gretl.pc \
	  $(DESTDIR)$(mandir)/man1/gretl.1 \
	  $(DESTDIR)$(datarootdir)/metainfo/gretl.appdata.xml
	rm -f $(DESTDIR)$(localedir)/*/LC_MESSAGES/gretl.mo
	@if [ "x$(DESTDIR)" = "x" ] ; then \
	  if command -v ldconfig >/dev/null 2>&1 ; then ldconfig ; fi ; \
	fi

uninstall-xdg:
	@if [ "x$(use_xdg)" != "xyes" ] ; then exit 0 ; fi ; \
	if [ "x$(DESTDIR)" != "x" ] || [ "x$(use_xdg_utils)" != "xyes" ] ; then \
	  rm -f \
	    $(DESTDIR)$(datadir)/applications/gretl.desktop \
	    $(DESTDIR)$(datadir)/applications/gretl_edit.desktop \
	    $(DESTDIR)$(datadir)/mime/packages/gretl.xml \
	    $(DESTDIR)$(datadir)/icons/hicolor/32x32/mimetypes/application-gretl.data.png \
	    $(DESTDIR)$(datadir)/icons/hicolor/32x32/mimetypes/application-gretl.bindata.png \
	    $(DESTDIR)$(datadir)/icons/hicolor/32x32/mimetypes/application-gretl.session.png \
	    $(DESTDIR)$(datadir)/icons/hicolor/32x32/mimetypes/text-gretl.script.png ; \
	  for f in 32 48 64 ; do \
	    rm -f \
	      $(DESTDIR)$(datadir)/icons/hicolor/$${f}x$${f}/apps/gretl.png \
	      $(DESTDIR)$(datadir)/icons/hicolor/$${f}x$${f}/apps/gretl_edit.png ; \
	  done ; \
	else \
	  owned_by_pkg() { \
	    p="$$1" ; \
	    if [ ! -e "$$p" ] ; then return 1 ; fi ; \
	    if command -v dpkg >/dev/null 2>&1 && dpkg -S "$$p" >/dev/null 2>&1 ; then return 0 ; fi ; \
	    if command -v rpm >/dev/null 2>&1 && rpm -qf "$$p" >/dev/null 2>&1 ; then return 0 ; fi ; \
	    if command -v pacman >/dev/null 2>&1 && pacman -Qo "$$p" >/dev/null 2>&1 ; then return 0 ; fi ; \
	    return 1 ; \
	  } ; \
	  if command -v xdg-desktop-menu >/dev/null 2>&1 ; then \
	    if ! owned_by_pkg /usr/share/applications/gretl.desktop ; then xdg-desktop-menu uninstall gretl.desktop || true ; fi ; \
	    if ! owned_by_pkg /usr/share/applications/gretl_edit.desktop ; then xdg-desktop-menu uninstall gretl_edit.desktop || true ; fi ; \
	  fi ; \
	  if command -v xdg-mime >/dev/null 2>&1 ; then \
	    if ! owned_by_pkg /usr/share/mime/packages/gretl.xml ; then xdg-mime uninstall $(topsrc)/xdg/gretl.xml || true ; fi ; \
	  fi ; \
	  if command -v xdg-icon-resource >/dev/null 2>&1 ; then \
	    if [ -e /usr/share/icons/hicolor/32x32/mimetypes/application-gretl.data.png ] && ! owned_by_pkg /usr/share/icons/hicolor/32x32/mimetypes/application-gretl.data.png ; then xdg-icon-resource uninstall --context mimetypes --size 32 application-gretl.data || true ; fi ; \
	    if [ -e /usr/share/icons/hicolor/32x32/mimetypes/application-gretl.bindata.png ] && ! owned_by_pkg /usr/share/icons/hicolor/32x32/mimetypes/application-gretl.bindata.png ; then xdg-icon-resource uninstall --context mimetypes --size 32 application-gretl.bindata || true ; fi ; \
	    if [ -e /usr/share/icons/hicolor/32x32/mimetypes/application-gretl.session.png ] && ! owned_by_pkg /usr/share/icons/hicolor/32x32/mimetypes/application-gretl.session.png ; then xdg-icon-resource uninstall --context mimetypes --size 32 application-gretl.session || true ; fi ; \
	    if [ -e /usr/share/icons/hicolor/32x32/mimetypes/text-gretl.script.png ] && ! owned_by_pkg /usr/share/icons/hicolor/32x32/mimetypes/text-gretl.script.png ; then xdg-icon-resource uninstall --context mimetypes --size 32 text-gretl.script || true ; fi ; \
	    for f in 32 48 64 ; do \
	      if [ -e /usr/share/icons/hicolor/$${f}x$${f}/apps/gretl.png ] && ! owned_by_pkg /usr/share/icons/hicolor/$${f}x$${f}/apps/gretl.png ; then xdg-icon-resource uninstall --context apps --size $$f gretl || true ; fi ; \
	      if [ -e /usr/share/icons/hicolor/$${f}x$${f}/apps/gretl_edit.png ] && ! owned_by_pkg /usr/share/icons/hicolor/$${f}x$${f}/apps/gretl_edit.png ; then xdg-icon-resource uninstall --context apps --size $$f gretl_edit || true ; fi ; \
	    done ; \
	  fi ; \
	  remove_unowned() { \
	    p="$$1" ; \
	    if [ ! -e "$$p" ] ; then return 0 ; fi ; \
	    if command -v dpkg >/dev/null 2>&1 && dpkg -S "$$p" >/dev/null 2>&1 ; then return 0 ; fi ; \
	    if command -v rpm >/dev/null 2>&1 && rpm -qf "$$p" >/dev/null 2>&1 ; then return 0 ; fi ; \
	    if command -v pacman >/dev/null 2>&1 && pacman -Qo "$$p" >/dev/null 2>&1 ; then return 0 ; fi ; \
	    rm -f "$$p" ; \
	  } ; \
	  remove_unowned /usr/share/applications/gretl.desktop ; \
	  remove_unowned /usr/share/applications/gretl_edit.desktop ; \
	  remove_unowned /usr/share/mime/packages/gretl.xml ; \
	  remove_unowned /usr/share/mime/application/gretl.data.xml ; \
	  remove_unowned /usr/share/mime/application/gretl.bindata.xml ; \
	  remove_unowned /usr/share/mime/application/gretl.session.xml ; \
	  remove_unowned /usr/share/mime/text/gretl.script.xml ; \
	  remove_unowned /usr/share/icons/hicolor/32x32/apps/gretl.png ; \
	  remove_unowned /usr/share/icons/hicolor/32x32/apps/gretl_edit.png ; \
	  remove_unowned /usr/share/icons/hicolor/48x48/apps/gretl.png ; \
	  remove_unowned /usr/share/icons/hicolor/48x48/apps/gretl_edit.png ; \
	  remove_unowned /usr/share/icons/hicolor/64x64/apps/gretl.png ; \
	  remove_unowned /usr/share/icons/hicolor/64x64/apps/gretl_edit.png ; \
	  remove_unowned /usr/share/icons/hicolor/32x32/mimetypes/application-gretl.data.png ; \
	  remove_unowned /usr/share/icons/hicolor/32x32/mimetypes/application-gretl.bindata.png ; \
	  remove_unowned /usr/share/icons/hicolor/32x32/mimetypes/application-gretl.session.png ; \
	  remove_unowned /usr/share/icons/hicolor/32x32/mimetypes/text-gretl.script.png ; \
	  remove_unowned /usr/share/icons/hicolor/32x32/mimetypes/gnome-mime-application-gretl.data.png ; \
	  remove_unowned /usr/share/icons/hicolor/32x32/mimetypes/gnome-mime-application-gretl.bindata.png ; \
	  remove_unowned /usr/share/icons/hicolor/32x32/mimetypes/gnome-mime-application-gretl.session.png ; \
	  remove_unowned /usr/share/icons/hicolor/32x32/mimetypes/gnome-mime-text-gretl.script.png ; \
	  if command -v update-mime-database >/dev/null 2>&1 ; then update-mime-database /usr/share/mime || true ; fi ; \
	  if command -v update-desktop-database >/dev/null 2>&1 ; then update-desktop-database /usr/share/applications || true ; fi ; \
	  if command -v gtk-update-icon-cache >/dev/null 2>&1 ; then gtk-update-icon-cache -f /usr/share/icons/hicolor 2>/dev/null || true ; fi ; \
	fi

tags:
	etags $(topsrc)/lib/src/*.[ch] $(topsrc)/cli/*.[ch] \
	$(topsrc)/$(GUIDIR)/*.[ch] $(topsrc)/plugin/*.[ch] \
	$(topsrc)/cephes/*.c $(topsrc)/plugin/zipunzip/*.[ch] \
	$(topsrc)/plugin/rq/*.[ch] $(topsrc)/$(EDDIR)/*.[ch]

builddate: $(topsrc)/builddate.c
	$(HOSTCC) -o $@ $<

buildstamp: builddate
	./builddate

dist: 
	$(tooldir)/makedist

distclean: clean
	rm -f config.log config.cache config.status config.h gretl.pc
	for d in $(SUBDIRS) $(DOCDIR) apidemo tests osx utils/emacs ; do \
	$(MAKE) -C $$d distclean ; done
	rm -f gretl_sh libtool Makefile redhat/gretl.spec

check:
	$(MAKE) -C tests check
	$(MAKE) -C unittests

osx-dist:
	$(MAKE) -C osx postinst

# dependencies for parallel builds
lib: buildstamp
cli: lib
share: lib
$(GUIDIR): lib
$(EDDIR): lib
plugin: lib
tests: lib
$(ADDONSDIR): cli
